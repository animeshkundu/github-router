name: CI

on:
  pull_request:
    types: [opened, synchronize, reopened]
  workflow_call:

jobs:
  ci:
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, windows-latest]
    runs-on: ${{ matrix.os }}
    steps:
      - uses: actions/checkout@v4

      - uses: oven-sh/setup-bun@v2
        with:
          bun-version: "1.2.19"

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Lint
        if: matrix.os == 'ubuntu-latest'
        run: bun run lint:all

      - name: Type check
        if: matrix.os == 'ubuntu-latest'
        run: bun run typecheck

      - name: Build
        run: bun run build

      - name: Test
        run: bun test tests/ --timeout 15000

      - name: Test (isolated - mock.module process isolation)
        shell: bash
        run: |
          shopt -s nullglob
          files=(tests/isolated/*.test.ts)
          if [ ${#files[@]} -eq 0 ]; then
            echo "ERROR: No isolated test files found"
            exit 1
          fi
          for f in "${files[@]}"; do
            echo "--- Running $f ---"
            bun test "$f" --timeout 15000
          done

  node-compat:
    needs: ci
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest]
    runs-on: ${{ matrix.os }}
    steps:
      - uses: actions/checkout@v4

      - uses: oven-sh/setup-bun@v2
        with:
          bun-version: "1.2.19"

      - uses: actions/setup-node@v4
        with:
          node-version: "22"

      - name: Install and build
        run: |
          bun install --frozen-lockfile
          bun run build

      - name: Verify CLI help on Node.js
        run: node dist/main.js --help

      - name: Verify no unguarded Bun references
        shell: bash
        run: |
          node -e '
            const fs = require("fs");
            const lines = fs.readFileSync("dist/main.js", "utf8").split("\n");
            const issues = [];
            for (let i = 0; i < lines.length; i++) {
              if (/Bun\./.test(lines[i]) && !/typeof Bun/.test(lines[i])) {
                const ctx = lines.slice(Math.max(0, i-3), i+1).join("\n");
                if (!/typeof Bun/.test(ctx)) issues.push({ line: i+1, text: lines[i].trim() });
              }
            }
            if (issues.length) { console.error("Unguarded Bun refs:", issues); process.exit(1); }
            console.log("OK: all Bun references guarded");
          '

      - name: E2E smoke test on Node.js (with mock API)
        shell: bash
        run: |
          node -e '
            const http = require("http");
            const { spawn } = require("child_process");

            // 1. Start mock GitHub/Copilot API server
            const mockApi = http.createServer((req, res) => {
              res.setHeader("content-type", "application/json");
              if (req.url.includes("/copilot_internal/v2/token")) {
                res.end(JSON.stringify({ token: "mock-token", refresh_in: 99999, endpoints: { api: "http://127.0.0.1:19877" } }));
              } else if (req.url.includes("/user")) {
                res.end(JSON.stringify({ login: "ci-test" }));
              } else if (req.url.includes("/models")) {
                res.end(JSON.stringify({ data: [{ id: "gpt-4", capabilities: { family: "gpt-4", limits: {}, object: "model_capabilities", supports: {}, tokenizer: "o200k_base", type: "chat" }, model_picker_enabled: true, name: "GPT-4", object: "model", preview: false, vendor: "OpenAI", version: "gpt-4" }] }));
              } else {
                res.end(JSON.stringify({ id: "test", object: "chat.completion", choices: [{ message: { content: "hello" } }] }));
              }
            });
            mockApi.listen(19877, "127.0.0.1", () => {
              console.log("Mock API on :19877");

              // 2. Start github-router pointing at mock
              const router = spawn("node", ["dist/main.js", "start", "-p", "19876"], {
                stdio: "inherit",
                env: { ...process.env, GITHUB_API_URL: "http://127.0.0.1:19877", COPILOT_API_URL: "http://127.0.0.1:19877", GH_TOKEN: "mock-github-token" }
              });

              // 3. Poll until router responds
              const check = () => http.get("http://127.0.0.1:19876/models", r => {
                let body = "";
                r.on("data", c => body += c);
                r.on("end", () => {
                  if (r.statusCode === 200 && body.includes("gpt-4")) {
                    console.log("OK: router responds with models from mock API");
                    router.kill(); mockApi.close(); process.exit(0);
                  } else {
                    console.log("Status:", r.statusCode, "Body:", body.slice(0, 200));
                    setTimeout(check, 500);
                  }
                });
              }).on("error", () => setTimeout(check, 500));
              setTimeout(check, 3000);
              setTimeout(() => { console.error("FAIL: timeout"); router.kill(); mockApi.close(); process.exit(1); }, 30000);
            });
          '
